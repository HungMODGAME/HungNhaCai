<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Hệ thống Tạo Giftcode</title>
    <style>
        body { background: #111; color: white; font-family: sans-serif; padding: 20px; }
        .box { background: #222; padding: 20px; border-radius: 10px; max-width: 500px; margin-bottom: 20px; border: 1px solid #f1c40f; }
        input { width: 100%; padding: 10px; margin: 10px 0; background: #333; border: 1px solid #444; color: white; }
        button { width: 100%; padding: 12px; background: #f1c40f; border: none; font-weight: bold; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #444; padding: 10px; text-align: center; }
        .copy-btn { background: #2ecc71; padding: 5px; font-size: 12px; width: auto; }
        .del-btn { background: #e74c3c; padding: 5px; font-size: 12px; width: auto; }
    </style>
</head>
<body>
    <h2>QUẢN LÝ GIFTCODE TOÀN HỆ THỐNG</h2>
    
    <div class="box">
        <input type="text" id="makhau" placeholder="Mã Code (VD: TANTHU88)">
        <input type="number" id="money" placeholder="Giá trị tiền (VND)">
        <input type="number" id="devices" placeholder="Số lượng thiết bị tối đa">
        <input type="number" id="perAcc" placeholder="Số lượt nhập/1 tài khoản">
        <button onclick="createCode()">XÁC NHẬN TẠO</button>
    </div>

    <table id="codeTable">
        <thead>
            <tr>
                <th>CODE</th>
                <th>GIÁ TRỊ</th>
                <th>THIẾT BỊ</th>
                <th>HÀNH ĐỘNG</th>
            </tr>
        </thead>
        <tbody id="list-codes"></tbody>
    </table>

    <script>
        const DB_URL = "https://giftcode-taixiu-default-rtdb.firebaseio.com/codes";

        async function createCode() {
            let code = document.getElementById('makhau').value.trim().toUpperCase();
            let val = document.getElementById('money').value;
            let dev = document.getElementById('devices').value;
            let acc = document.getElementById('perAcc').value;

            if(!code || !val) return alert("Nhập đủ thông tin!");

            let newCode = {
                value: parseInt(val),
                maxDevices: parseInt(dev),
                usedDevices: 0,
                maxPerAccount: parseInt(acc)
            };

            await fetch(`${DB_URL}/${code}.json`, {
                method: 'PUT',
                body: JSON.stringify(newCode)
            });

            alert("Đã tạo code thành công!");
            loadCodes();
        }

        async function loadCodes() {
            let res = await fetch(`${DB_URL}.json`);
            let data = await res.json();
            let html = "";
            for (let key in data) {
                if(!data[key]) continue;
                // Tự động xóa nếu đạt giới hạn thiết bị
                if(data[key].usedDevices >= data[key].maxDevices) {
                    deleteCode(key);
                    continue;
                }
                html += `<tr>
                    <td>${key}</td>
                    <td>${data[key].value.toLocaleString()}</td>
                    <td>${data[key].usedDevices}/${data[key].maxDevices}</td>
                    <td>
                        <button class="copy-btn" onclick="navigator.clipboard.writeText('${key}')">Copy</button>
                        <button class="del-btn" onclick="deleteCode('${key}')">Xóa</button>
                    </td>
                </tr>`;
            }
            document.getElementById('list-codes').innerHTML = html;
        }

        async function deleteCode(code) {
            await fetch(`${DB_URL}/${code}.json`, { method: 'DELETE' });
            loadCodes();
        }

        setInterval(loadCodes, 3000);
        loadCodes();
    </script>
</body>
</html>