<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NHÃ€ CÃI - VUA MODS</title>
    <style>
        /* GIá»® NGUYÃŠN TOÃ€N Bá»˜ CSS Cá»¦A Báº N */
        :root { --gold: #f1c40f; --red: #e74c3c; --green: #2ecc71; --bg: #0d0d0d; --card: #1a1a1a; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; outline: none; user-select: none; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; height: 100vh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }
        #rotate-warning { display: none; position: fixed; inset: 0; background: #000; z-index: 99999; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        #rotate-warning .icon { font-size: 60px; animation: rotatePhone 2s infinite; }
        @keyframes rotatePhone { 0% { transform: rotate(0deg); } 50% { transform: rotate(-90deg); } 100% { transform: rotate(0deg); } }
        @media screen and (orientation: portrait) and (max-width: 1024px) { #rotate-warning { display: flex; } }
        .header { height: 60px; background: #111; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--gold); flex-shrink: 0; z-index: 100; }
        .game-main-horizontal { flex: 1; display: flex; align-items: center; justify-content: space-around; padding: 10px; gap: 10px; background: radial-gradient(circle, #222 0%, #000 100%); }
        .side-bet-container { width: 25%; max-width: 230px; display: flex; flex-direction: column; gap: 8px; position: relative; }
        .center-container { width: 40%; text-align: center; position: relative; display: flex; flex-direction: column; align-items: center; }
        @media (max-height: 500px) { .header { height: 45px; } #timer { font-size: 2.5rem !important; margin-bottom: 0 !important; } .plate-area { width: 140px !important; height: 140px !important; } .dice { width: 30px !important; height: 30px !important; line-height: 30px !important; font-size: 1.2rem !important; } .bet-box { padding: 5px !important; } }
        #auth-overlay { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .auth-box { background: var(--card); padding: 30px; border-radius: 15px; border: 1px solid var(--gold); width: 320px; text-align: center; }
        .auth-input { width: 100%; padding: 12px; margin: 8px 0; background: #222; border: 1px solid #444; color: white; border-radius: 8px; }
        .balance-box { color: var(--gold); font-weight: bold; font-family: monospace; font-size: 1.2rem; }
        .user-icon, .sc-icon, .audio-icon { width: 45px; height: 45px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid var(--gold); cursor: pointer; transition: 0.3s; }
        .audio-icon:active { transform: scale(0.9); }
        .user-panel { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000; align-items: center; justify-content: center; }
        .panel-card { background: var(--card); width: 95%; max-width: 400px; border-radius: 20px; border: 1px solid #333; overflow: hidden; }
        .panel-tabs { display: flex; background: #111; }
        .p-tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; color: #666; font-weight: bold; border-bottom: 2px solid transparent; }
        .p-tab.active { color: var(--gold); border-bottom-color: var(--gold); }
        .p-content { padding: 20px; display: none; }
        .p-content.active { display: block; }
        #withdraw-loading { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9000; flex-direction: column; align-items: center; justify-content: center; }
        .loader { border: 5px solid #333; border-top: 5px solid var(--gold); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #video-overlay { display: none; position: fixed; inset: 0; background: #000; z-index: 10000; align-items: center; justify-content: center; }
        #withdraw-video { width: 100%; max-height: 100vh; }
        #timer { font-size: 4rem; color: var(--red); font-weight: 900; margin-bottom: 5px; }
        .plate-area { position: relative; width: 200px; height: 200px; background: #fff; border-radius: 50%; border: 8px solid #2c3e50; display: flex; justify-content: center; align-items: center; }
        .dice { width: 42px; height: 42px; color: black; line-height: 42px; font-weight: bold; font-size: 1.8rem; margin: 0 20px; text-align: center; }
        #bowl { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 30% 30%, #555, #000); border-radius: 50%; z-index: 10; cursor: grab; touch-action: none; }
        .bet-box { background: rgba(30, 30, 30, 0.9); border: 2px solid #444; border-radius: 15px; padding: 12px; text-align: center; position: relative; cursor: pointer; }
        .my-bet-info { background: var(--gold); color: #000; font-size: 0.8rem; font-weight: bold; padding: 3px 10px; border-radius: 5px; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); display: none; }
        .total-money { color: var(--gold); font-weight: bold; font-size: 1.1rem; }
        .cancel-btn { width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: #888; border-radius: 8px; font-size: 0.8rem; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .bet-selector { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .selector-card { background: #1a1a1a; padding: 25px; border-radius: 20px; border: 2px solid var(--gold); width: 300px; text-align: center; }
        .amt-btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .amt-btn { padding: 10px; background: #333; color: white; border: none; border-radius: 8px; font-weight: bold; }
        .popup { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; align-items: center; justify-content: center; }
        .card { background: #1a1a1a; width: 90%; max-width: 450px; padding: 25px; border-radius: 15px; border: 1px solid #333; }
        .bank-suggest { position: absolute; background: #222; border: 1px solid #444; width: 100%; max-height: 120px; overflow-y: auto; z-index: 10; display: none; }
        .bank-item { padding: 10px; border-bottom: 1px solid #333; cursor: pointer; font-size: 0.9rem; }
        /* Giao diá»‡n RÃºt tiá»n máº·c Ä‘á»‹nh (PC) */
#p1 {
    display: none; /* Sáº½ Ä‘Æ°á»£c script Ä‘iá»u khiá»ƒn active */
}

#p1.active {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Tá»‘i Æ°u riÃªng cho Mobile xoay ngang */
@media (max-height: 500px) {
    /* Chia 4 Ã´ nháº­p liá»‡u thÃ nh 2 hÃ ng, má»—i hÃ ng 2 cá»™t */
    #p1.active {
        display: grid !important;
        grid-template-columns: 1fr 1fr; 
        gap: 8px;
        padding: 10px;
    }

    /* Ã” ngÃ¢n hÃ ng vÃ  nÃºt rÃºt tiá»n cho chiáº¿m háº¿t chiá»u ngang Ä‘á»ƒ dá»… thao tÃ¡c */
    #p1.active div:first-child, 
    #p1.active button {
        grid-column: span 2;
    }

    /* Thu nhá» cÃ¡c input Ä‘á»ƒ tiáº¿t kiá»‡m diá»‡n tÃ­ch */
    #p1 .auth-input {
        margin: 0 !important;
        padding: 8px !important;
        font-size: 0.85rem;
    }

    /* Thu nhá» nÃºt ÄÃ³ng á»Ÿ dÆ°á»›i cÃ¹ng */
    .user-panel .panel-card > button {
        padding: 10px !important;
        font-size: 0.9rem;
    }
    
    /* Thu nhá» cÃ¡c Tab Ä‘á»ƒ nhÆ°á»ng chá»— cho ná»™i dung */
    .p-tab {
        padding: 8px !important;
        font-size: 0.8rem;
    }
}
    </style>
</head>
<body>

<audio id="bg-music" loop>
    <source src="xoso.mp3" type="audio/mpeg">
</audio>

<div id="rotate-warning"><div class="icon">ğŸ”„</div><h2 style="color:var(--gold); margin-top:15px;">VUI LÃ’NG XOAY NGANG MÃ€N HÃŒNH</h2><p style="color:#888;">Äá»ƒ cÃ³ tráº£i nghiá»‡m chÆ¡i tá»‘t nháº¥t trÃªn thiáº¿t bá»‹ di Ä‘á»™ng</p></div>
<div id="withdraw-loading"><div class="loader"></div><p style="color:var(--gold); margin-top:15px; font-weight:bold;">ÄANG KIá»‚M TRA GIAO Dá»ŠCH...</p></div>
<div id="video-overlay"><video id="withdraw-video" playsinline><source src="thayhuan.mp4" type="video/mp4"></video></div>
<div id="auth-overlay"><div class="auth-box"><h2 id="auth-title" style="color:var(--gold); margin-bottom:15px;">ÄÄ‚NG NHáº¬P</h2><input type="text" id="user-in" class="auth-input" placeholder="TÃªn tÃ i khoáº£n"><input type="password" id="pass-in" class="auth-input" placeholder="Máº­t kháº©u"><button onclick="authAction()" style="width:100%; padding:12px; background:var(--green); border:none; border-radius:8px; color:white; font-weight:bold; margin-top:10px;">XÃC NHáº¬N</button><p onclick="switchAuth()" id="auth-switch" style="font-size:0.8rem; color:#888; margin-top:15px; cursor:pointer;">ChÆ°a cÃ³ tÃ i khoáº£n? ÄÄƒng kÃ½</p></div></div>

<div class="header">
    <div class="user-icon" onclick="openUserPanel()">ğŸ‘¤</div>
    <div class="balance-box">ğŸ’° <span id="balance-display">0</span></div>
    <div style="display: flex; gap: 10px;">
        <div class="audio-icon" id="btn-audio" onclick="toggleMusic()">ğŸ”Š</div>
        <div class="sc-icon" onclick="moSoiCau()">Cáº¦U</div>
    </div>
</div>

<div class="user-panel" id="user-panel">
    <div class="panel-card">
        <div class="panel-tabs"><div class="p-tab active" onclick="showP(0)">THÃ”NG TIN</div><div class="p-tab" onclick="showP(1)">RÃšT TIá»€N</div><div class="p-tab" onclick="showP(2)">GIFTCODE</div></div>
        <div class="p-content active" id="p0"><p style="margin:10px 0;">ğŸ‘¤ Chá»§ Tá»‹ch : <b id="p-name" style="color:var(--gold)">--</b></p><p style="margin:10px 0;">ğŸ’° Sá»‘ dÆ°: <b id="p-bal" style="color:var(--green)">0</b></p><button onclick="doLogout()" style="width:100%; padding:12px; background:var(--red); border:none; border-radius:8px; color:white; margin-top:20px;">ÄÄ‚NG XUáº¤T</button></div>
        <div class="p-content" id="p1"><div style="position:relative;"><input type="text" id="w-bank" class="auth-input" placeholder="TÃªn ngÃ¢n hÃ ng..." oninput="suggestBank()"><div class="bank-suggest" id="b-list"></div></div><input type="text" id="w-stk" class="auth-input" placeholder="Sá»‘ tÃ i khoáº£n"><input type="text" id="w-name" class="auth-input" placeholder="TÃªn chá»§ tháº» (In hoa khÃ´ng dáº¥u)"><input type="text" id="w-amt" class="auth-input" placeholder="Sá»‘ tiá»n rÃºt (Min 1.000.000)" oninput="formatAmt(this)"><button onclick="doWithdraw()" style="width:100%; padding:12px; background:var(--gold); border:none; border-radius:8px; font-weight:bold; margin-top:10px;">RÃšT TIá»€N</button></div>
        <div class="p-content" id="p2"><input type="text" id="g-code" class="auth-input" placeholder="Nháº­p mÃ£ Giftcode"><button onclick="doGift()" style="width:100%; padding:12px; background:var(--green); border:none; border-radius:8px; color:white; font-weight:bold; margin-top:10px;">NHáº¬N THÆ¯á»NG</button></div>
        <button onclick="closeUserPanel()" style="width:100%; padding:15px; background:#222; border:none; color:white; border-top:1px solid #333;">ÄÃ“NG</button>
    </div>
</div>

<div class="game-main-horizontal">
    <div class="side-bet-container"><div id="res-xiu" style="display:none; text-align:center; font-weight:bold; color:var(--red); position:absolute; top:-30px; width:100%;"></div><div class="bet-box" id="box-xiu" onclick="moSelector('Xiu')"><div id="bet-xiu-val" class="my-bet-info">0</div><div class="stat-line">ğŸ‘¤ <span id="bot-p-xiu">0</span></div><div style="color:var(--red); font-size:2.2rem; font-weight:900;">Xá»ˆU</div><div class="total-money" id="bot-m-xiu">0</div></div><button class="cancel-btn" onclick="huyCuoc('Xiu')">Há»¦Y CÆ¯á»¢C Xá»ˆU</button></div>
    <div class="center-container"><div id="status-msg">Má»œI Äáº¶T CÆ¯á»¢C</div><div id="timer">60</div><div class="plate-area" id="plate"><div id="dice-wrap"><span class="dice">?</span><span class="dice">?</span><span class="dice">?</span></div><div id="bowl" style="display: none;"></div></div></div>
    <div class="side-bet-container"><div id="res-tai" style="display:none; text-align:center; font-weight:bold; color:var(--green); position:absolute; top:-30px; width:100%;"></div><div class="bet-box" id="box-tai" onclick="moSelector('Tai')"><div id="bet-tai-val" class="my-bet-info">0</div><div class="stat-line">ğŸ‘¤ <span id="bot-p-tai">0</span></div><div style="color:var(--green); font-size:2.2rem; font-weight:900;">TÃ€I</div><div class="total-money" id="bot-m-tai">0</div></div><button class="cancel-btn" onclick="huyCuoc('Tai')">Há»¦Y CÆ¯á»¢C TÃ€I</button></div>
</div>

<div class="bet-selector" id="bet-selector-ui"><div class="selector-card"><h2 id="select-title" style="color:var(--gold)">CÆ¯á»¢C</h2><div style="font-size: 2rem; margin: 15px 0;" id="temp-amt-view">0</div><div class="amt-btn-group">
    <button class="amt-btn" onclick="congTien(1000)">1K</button>
    <button class="amt-btn" onclick="congTien(5000)">5K</button>
    <button class="amt-btn" onclick="congTien(10000)">10K</button>
    <button class="amt-btn" onclick="congTien(100000)">100K</button>
    <button class="amt-btn" onclick="congTien(500000)">500K</button>
    <button class="amt-btn" onclick="congTien(1000000)">1M</button>
    <button class="amt-btn" onclick="congTien(5000000)">5M</button>
    <button class="amt-btn" onclick="congTien(10000000)">10M</button>
    <button class="amt-btn" onclick="congTien(50000000)">50M</button>
    <button class="amt-btn" onclick="congTien('ALL')" style="background:var(--gold); color:#000;">Táº¤T TAY</button></div><button onclick="xacNhanCuoc()" style="width:100%; padding:15px; background:var(--green); border:none; border-radius:10px; color:white; font-weight:bold;">Äáº¶T CÆ¯á»¢C</button><button onclick="dongSelector()" style="width:100%; padding:10px; background:#444; border:none; border-radius:10px; color:white; margin-top:10px;">Há»¦Y</button></div></div>

<div class="popup" id="popup-soicau">
    <div class="card" style="max-width: 95vw; width: 600px; position: relative;">
        <h2 style="text-align:center; color:var(--gold); margin-bottom: 15px;">BIá»‚U Äá»’ SOI Cáº¦U</h2>
        <canvas id="canvas-soicau" style="width:100%; height:200px; background:#000; border:1px solid #333;"></canvas>
        <button onclick="closePopup('popup-soicau')" style="width:100%; padding:15px; background:var(--red); border:none; border-radius:10px; color:white; font-weight:bold; margin-top:15px; cursor:pointer;">ÄÃ“NG Báº¢NG SOI Cáº¦U</button>
    </div>
</div>

<script>
    let userBalance = 50000, loggedUser = null, isLogin = true, isMusicPlaying = false;
    let lichSuCau = [], botPlayerXiu = 0, botMoneyXiu = 0, botPlayerTai = 0, botMoneyTai = 0;
    let realMoneyXiu = 0, realMoneyTai = 0; 
    let currentBetSide = "", currentBetAmount = 0, ketQuaHienTai = [1, 1, 1], daNanBat = false, tempSelectAmount = 0;
    const listBank = ["Vietcombank", "Techcombank", "Agribank", "MB Bank", "BIDV", "Vietinbank", "ACB", "TPBank", "Sacombank", "VPBank"];

    // --- LOGIC NHáº C ---
    function toggleMusic() {
        const music = document.getElementById('bg-music');
        const btn = document.getElementById('btn-audio');
        if (isMusicPlaying) {
            music.pause();
            btn.innerText = "ğŸ”‡";
            btn.style.borderColor = "#444";
        } else {
            music.play().catch(e => console.log("Cáº§n tÆ°Æ¡ng tÃ¡c Ä‘á»ƒ phÃ¡t nháº¡c"));
            btn.innerText = "ğŸ”Š";
            btn.style.borderColor = "var(--gold)";
        }
        isMusicPlaying = !isMusicPlaying;
    }

    // --- HÃ€M ÄÃ“NG POPUP ---
    function closePopup(id) { const p = document.getElementById(id); if(p) p.style.display = "none"; }

    function getSyncDice(roundId, seedOffset) {
        let t = (roundId + seedOffset) + 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return Math.floor((((t ^ t >>> 14) >>> 0) / 4294967296) * 6) + 1;
    }

    function switchAuth() { isLogin = !isLogin; document.getElementById('auth-title').innerText = isLogin ? "ÄÄ‚NG NHáº¬P" : "ÄÄ‚NG KÃ"; document.getElementById('auth-switch').innerText = isLogin ? "ChÆ°a cÃ³ tÃ i khoáº£n? ÄÄƒng kÃ½" : "ÄÃ£ cÃ³ tÃ i khoáº£n? ÄÄƒng nháº­p"; }
    
    // ÄÃ£ thÃªm lá»‡nh phÃ¡t nháº¡c khi nháº¥n nÃºt XÃ¡c Nháº­n Ä‘Äƒng nháº­p
    function authAction() { 
        let u = document.getElementById('user-in').value; 
        if(u.length < 3) return alert("TÃªn quÃ¡ ngáº¯n!"); 
        loggedUser = u; 
        document.getElementById('auth-overlay').style.display = "none"; 
        document.getElementById('p-name').innerText = u; 
        
        // Tá»± Ä‘á»™ng phÃ¡t nháº¡c khi vÃ o game
        const music = document.getElementById('bg-music');
        music.play();
        isMusicPlaying = true;
        document.getElementById('btn-audio').innerText = "ğŸ”Š";

        saveData(); 
        capNhatBalance(); 
    }

    function doLogout() { localStorage.removeItem('TX_SESS_V4'); location.reload(); }
    function openUserPanel() { document.getElementById('user-panel').style.display = "flex"; document.getElementById('p-bal').innerText = userBalance.toLocaleString() + " VND"; }
    function closeUserPanel() { document.getElementById('user-panel').style.display = "none"; }
    function showP(idx) { document.querySelectorAll('.p-tab').forEach((t, i) => t.classList.toggle('active', i === idx)); document.querySelectorAll('.p-content').forEach((c, i) => c.classList.toggle('active', i === idx)); }

    function doWithdraw() {
        let val = document.getElementById('w-amt').value.replace(/\D/g, ""); let amt = parseInt(val);
        if(!val || amt < 1000000) return alert("RÃºt tá»‘i thiá»ƒu 1.000.000 VND");
        if(amt > userBalance) return alert("KhÃ´ng Ä‘á»§ sá»‘ dÆ°");
        document.getElementById('withdraw-loading').style.display = "flex";
        setTimeout(() => {
            document.getElementById('withdraw-loading').style.display = "none"; userBalance -= amt; capNhatBalance(); closeUserPanel();
            const overlay = document.getElementById('video-overlay'); const video = document.getElementById('withdraw-video');
            overlay.style.display = "flex"; video.play();
            video.onended = () => { overlay.style.display = "none"; alert("YÃªu cáº§u rÃºt thÃ nh cÃ´ng!"); };
        }, 3000);
    }
    
    async function doGift() {
    let code = document.getElementById('g-code').value.trim().toUpperCase();
    if (!code) return alert("ChÆ°a nháº­p mÃ£!");

    const FIREBASE_URL = "https://hethongcode-7a64c-default-rtdb.asia-southeast1.firebasedatabase.app/giftcodes";
    
    try {
        // 1. Láº¥y dá»¯ liá»‡u code tá»« Firebase
        let res = await fetch(`${FIREBASE_URL}/${code}.json`);
        let data = await res.json();

        if (!data) return alert("MÃ£ Giftcode khÃ´ng tá»“n táº¡i!");

        // 2. Kiá»ƒm tra tá»•ng sá»‘ lÆ°á»£t nháº­p (Tá»•ng thiáº¿t bá»‹)
        if (data.used >= data.maxDevices) {
            return alert("MÃ£ nÃ y Ä‘Ã£ háº¿t lÆ°á»£t sá»­ dá»¥ng trÃªn toÃ n há»‡ thá»‘ng!");
        }

        // 3. Kiá»ƒm tra giá»›i háº¡n nháº­p cá»§a tá»«ng tÃ i khoáº£n (maxPerAcc)
        // LÆ°u trá»¯ lá»‹ch sá»­ nháº­p vÃ o localStorage cá»§a trÃ¬nh duyá»‡t
        let giftHistory = JSON.parse(localStorage.getItem('TX_GIFT_HISTORY') || "{}");
        let usedCount = giftHistory[code] || 0;

        if (usedCount >= data.maxPerAcc) {
            return alert(`Báº¡n Ä‘Ã£ háº¿t lÆ°á»£t nháº­p mÃ£ nÃ y (Tá»‘i Ä‘a: ${data.maxPerAcc} láº§n/acc)!`);
        }

        // 4. Thá»±c hiá»‡n cá»™ng tiá»n vÃ  cáº­p nháº­t há»‡ thá»‘ng
        // TÄƒng sá»‘ lÆ°á»£t dÃ¹ng trÃªn Firebase
        await fetch(`${FIREBASE_URL}/${code}.json`, {
            method: 'PATCH',
            body: JSON.stringify({ used: data.used + 1 })
        });

        // Cá»™ng tiá»n cho ngÆ°á»i chÆ¡i
        userBalance += data.money;
        
        // LÆ°u lá»‹ch sá»­ nháº­p cá»§a acc nÃ y
        giftHistory[code] = usedCount + 1;
        localStorage.setItem('TX_GIFT_HISTORY', JSON.stringify(giftHistory));

        // Cáº­p nháº­t giao diá»‡n
        capNhatBalance();
        alert(`ChÃºc má»«ng! Báº¡n Ä‘Ã£ nháº­n Ä‘Æ°á»£c ${data.money.toLocaleString()} VND`);
        document.getElementById('g-code').value = ""; // XÃ³a Ã´ nháº­p sau khi thÃ nh cÃ´ng
        closeUserPanel();

    } catch (e) {
        console.error(e);
        alert("Lá»—i káº¿t ná»‘i há»‡ thá»‘ng, vui lÃ²ng thá»­ láº¡i!");
    }
}

    function moSelector(side) {
        let elapsed = Math.floor(Date.now() / 1000) % 73;
        if(elapsed >= 55) return;
        if (currentBetSide !== "" && currentBetSide !== side && currentBetAmount > 0) { alert("Chá»‰ Ä‘Æ°á»£c cÆ°á»£c 1 bÃªn!"); return; }
        currentBetSide = side; tempSelectAmount = 0;
        document.getElementById('select-title').innerText = "CÆ¯á»¢C " + side.toUpperCase();
        document.getElementById('temp-amt-view').innerText = "0";
        document.getElementById('bet-selector-ui').style.display = "flex";
    }
    function congTien(v) { if(v==='ALL') tempSelectAmount = userBalance; else tempSelectAmount += v; if(tempSelectAmount > userBalance) tempSelectAmount = userBalance; document.getElementById('temp-amt-view').innerText = tempSelectAmount.toLocaleString(); }
    function xacNhanCuoc() {
        if(tempSelectAmount <= 0) return;
        userBalance -= tempSelectAmount;
        currentBetAmount += tempSelectAmount;
        if (currentBetSide === 'Xiu') realMoneyXiu += tempSelectAmount;
        else realMoneyTai += tempSelectAmount;
        capNhatBalance();
        let id = currentBetSide === "Xiu" ? 'bet-xiu-val' : 'bet-tai-val';
        document.getElementById(id).innerText = currentBetAmount.toLocaleString();
        document.getElementById(id).style.display = "block";
        document.getElementById(id).style.background = "var(--gold)";
        dongSelector();
    }
    function dongSelector() { document.getElementById('bet-selector-ui').style.display = "none"; }
    function huyCuoc(side) {
        let elapsed = Math.floor(Date.now() / 1000) % 73;
        if (elapsed < 55 && currentBetSide === side) {
            userBalance += currentBetAmount;
            if (side === 'Xiu') realMoneyXiu = 0; else realMoneyTai = 0;
            currentBetAmount = 0; currentBetSide = "";
            document.getElementById('bet-xiu-val').style.display = "none";
            document.getElementById('bet-tai-val').style.display = "none";
            capNhatBalance();
        }
    }

    setInterval(() => {
        const now = Date.now();
        const elapsed = Math.floor(now / 1000) % 73;
        const roundId = Math.floor(now / 73000);

        if (elapsed < 60) {
            document.getElementById('timer').innerText = 60 - elapsed;
            if (elapsed >= 55) {
                document.getElementById('status-msg').innerText = "Háº¾T THá»œI GIAN CÆ¯á»¢C";
                document.getElementById('status-msg').style.color = "var(--red)";
            } else {
                document.getElementById('status-msg').innerText = "Má»œI Äáº¶T CÆ¯á»¢C";
                document.getElementById('status-msg').style.color = "white";
                if (elapsed === 0) {
                    realMoneyXiu = 0; realMoneyTai = 0; daNanBat = false;
                    document.getElementById('res-xiu').style.display = "none";
                    document.getElementById('res-tai').style.display = "none";
                    document.getElementById('bet-xiu-val').style.display = "none";
                    document.getElementById('bet-tai-val').style.display = "none";
                    document.getElementById('bowl').style.display = "none";
                }
                let factor = Math.pow(elapsed / 55, 1.5);
                let baseM = 400000000 * factor;
                let diff = 1.2 + (Math.sin(elapsed) * 0.2);
                if (roundId % 2 === 0) {
                    botMoneyXiu = Math.floor(baseM * diff); botMoneyTai = Math.floor(baseM);
                } else {
                    botMoneyTai = Math.floor(baseM * diff); botMoneyXiu = Math.floor(baseM);
                }
                document.getElementById('bot-m-xiu').innerText = (botMoneyXiu + realMoneyXiu).toLocaleString();
                document.getElementById('bot-m-tai').innerText = (botMoneyTai + realMoneyTai).toLocaleString();
                document.getElementById('bot-p-xiu').innerText = Math.floor(2000 * factor).toLocaleString();
                document.getElementById('bot-p-tai').innerText = Math.floor(1800 * factor).toLocaleString();
            }
        } else {
            document.getElementById('timer').innerText = 70 - elapsed > 0 ? 70 - elapsed : 0;
            if (elapsed === 60) {
                ketQuaHienTai = [getSyncDice(roundId, 1), getSyncDice(roundId, 2), getSyncDice(roundId, 3)];
                document.querySelectorAll('.dice').forEach((d, i) => d.innerText = ketQuaHienTai[i]);
                document.getElementById('bowl').style.display = "block";
                document.getElementById('bowl').style.transform = "translate(0,0)";
                document.getElementById('bowl').style.opacity = "1";
            }
            if (elapsed === 72 && !daNanBat) moBat();
        }
    }, 1000);

   function moBat() {
    if(daNanBat) return; 
    daNanBat = true; 
    document.getElementById('bowl').style.display = "none";
    
    // 1. XÃ¡c Ä‘á»‹nh káº¿t quáº£ máº·c Ä‘á»‹nh ban Ä‘áº§u
    let sum = ketQuaHienTai.reduce((a,b)=>a+b, 0); 
    let winSide = sum >= 11 ? "Tai" : "Xiu";

    // 2. CAN THIá»†P LOGIC (Admin luÃ´n tháº¯ng / Cháº·n tháº¯ng > 950k)
    if (loggedUser === "HungPCADM" && currentBetSide !== "") {
        // Admin luÃ´n tháº¯ng: Náº¿u cÆ°á»£c gÃ¬ thÃ¬ Ã©p káº¿t quáº£ ra Ä‘Ã³
        winSide = currentBetSide;
        ketQuaHienTai = generateRandomDice(winSide);
        sum = ketQuaHienTai.reduce((a,b)=>a+b, 0);
    } else if (currentBetAmount > 0 && currentBetSide === winSide && loggedUser !== "HungPCADM") {
        // NgÆ°á»i thÆ°á»ng: Náº¿u tháº¯ng mÃ  vÆ°á»£t 950k thÃ¬ Ã©p cho THUA
        let duKienThang = userBalance + (currentBetAmount * 1.95);
        if (duKienThang > 950000) {
            winSide = (currentBetSide === "Tai") ? "Xiu" : "Tai";
            ketQuaHienTai = generateRandomDice(winSide);
            sum = ketQuaHienTai.reduce((a,b)=>a+b, 0);
        }
    }

    // 3. Cáº­p nháº­t láº¡i giao diá»‡n xÃºc xáº¯c sau khi Ä‘Ã£ can thiá»‡p logic
    document.querySelectorAll('.dice').forEach((d, i) => {
        d.innerText = ketQuaHienTai[i];
    });

    // 4. Cáº­p nháº­t lá»‹ch sá»­ cáº§u
    lichSuCau.push({side: winSide, total: sum}); 
    if(lichSuCau.length > 15) lichSuCau.shift();
    
    // 5. Xá»­ lÃ½ Cá»˜NG/TRá»ª TIá»€N vÃ  HIá»‚N THá»Š
    const nodeXiu = document.getElementById('bet-xiu-val');
    const nodeTai = document.getElementById('bet-tai-val');
    const resXiu = document.getElementById('res-xiu');
    const resTai = document.getElementById('res-tai');

    // Reset hiá»ƒn thá»‹ trÆ°á»›c khi tÃ­nh
    nodeXiu.style.display = "none";
    nodeTai.style.display = "none";
    resXiu.style.display = "none";
    resTai.style.display = "none";

    if (currentBetAmount > 0) {
        if (currentBetSide === winSide) {
            // THáº®NG: Cá»™ng tiá»n (Sá»‘ tiá»n cÆ°á»£c * 1.95)
            let winAmt = Math.floor(currentBetAmount * 1.95); 
            userBalance += winAmt;
            
            let targetNode = (winSide === "Tai") ? nodeTai : nodeXiu;
            targetNode.innerText = "+" + winAmt.toLocaleString();
            targetNode.style.display = "block"; 
            targetNode.style.background = "var(--green)";
            targetNode.style.color = "white";
        } else {
            // THUA: KhÃ´ng cá»™ng láº¡i tiá»n (VÃ¬ tiá»n Ä‘Ã£ trá»« lÃºc Ä‘áº·t cÆ°á»£c)
            let targetNode = (currentBetSide === "Tai") ? nodeTai : nodeXiu;
            targetNode.innerText = "-" + currentBetAmount.toLocaleString();
            targetNode.style.display = "block"; 
            targetNode.style.background = "var(--red)";
            targetNode.style.color = "white";
        }
    } else {
        // Náº¿u khÃ´ng cÆ°á»£c, chá»‰ hiá»‡n káº¿t quáº£ Xá»‰u(8) hoáº·c TÃ i(14)
        if (winSide === "Tai") { 
            resTai.innerText = "TÃ€I (" + sum + ")"; 
            resTai.style.display = "block"; 
        } else { 
            resXiu.innerText = "Xá»ˆU (" + sum + ")"; 
            resXiu.style.display = "block"; 
        }
    }
    
    // 6. Káº¿t thÃºc vÃ¡n: Reset biáº¿n cÆ°á»£c vÃ  LÆ°u dá»¯ liá»‡u
    currentBetAmount = 0; 
    currentBetSide = ""; 
    capNhatBalance();
    saveData();
}

// HÃ m há»— trá»£ táº¡o xÃºc sáº¯c ngáº«u nhiÃªn (Pháº£i cÃ³ hÃ m nÃ y)
function generateRandomDice(side) {
    let s, d1, d2, d3;
    do {
        d1 = Math.floor(Math.random() * 6) + 1;
        d2 = Math.floor(Math.random() * 6) + 1;
        d3 = Math.floor(Math.random() * 6) + 1;
        s = d1 + d2 + d3;
    } while ((side === "Tai" && s < 11) || (side === "Xiu" && s > 10));
    return [d1, d2, d3];
}

    function moSoiCau() { document.getElementById('popup-soicau').style.display = "flex"; setTimeout(drawCau, 200); }
    function drawCau() {
        const cv = document.getElementById('canvas-soicau'); const ctx = cv.getContext('2d');
        cv.width = cv.offsetWidth; cv.height = cv.offsetHeight;
        ctx.clearRect(0,0,cv.width,cv.height);
        let sx = cv.width/15, ah = cv.height - 40;
        ctx.beginPath(); ctx.strokeStyle = "#f1c40f"; ctx.lineWidth = 2;
        lichSuCau.forEach((d, i) => {
            let x = i*sx + sx/2, y = 20 + ah - ((d.total-3)/15 * ah);
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();
        lichSuCau.forEach((d, i) => {
            let x = i*sx + sx/2, y = 20 + ah - ((d.total-3)/15 * ah);
            ctx.fillStyle = d.side === "Tai" ? "#2ecc71" : "#e74c3c";
            ctx.beginPath(); ctx.arc(x,y,11,0,Math.PI*2); ctx.fill();
            ctx.fillStyle = "white"; ctx.font = "bold 10px Arial"; ctx.textAlign="center"; ctx.fillText(d.total, x, y+4);
        });
    }

    const bowl = document.getElementById('bowl');
    let isMove = false, curX = 0, curY = 0;
    bowl.onpointerdown = (e) => { isMove = true; bowl.setPointerCapture(e.pointerId); bowl.style.transition = "none"; };
    bowl.onpointermove = (e) => {
        if (!isMove) return;
        const r = document.getElementById('plate').getBoundingClientRect();
        curX = e.clientX - r.left - 100; curY = e.clientY - r.top - 100;
        bowl.style.transform = `translate(${curX}px, ${curY}px)`;
    };
    bowl.onpointerup = () => {
        isMove = false;
        if (Math.abs(curX) > 80 || Math.abs(curY) > 80) {
            bowl.style.transition = "0.4s"; bowl.style.opacity = "0";
            bowl.style.transform = `translate(${curX*2}px, ${curY*2}px)`;
            setTimeout(moBat, 400);
        } else {
            bowl.style.transition = "0.3s"; bowl.style.transform = "translate(0,0)";
        }
    };

    function suggestBank() { 
        let val = document.getElementById('w-bank').value.toLowerCase();
        let list = document.getElementById('b-list');
        list.innerHTML = "";
        if(!val) { list.style.display = "none"; return; }
        let matches = listBank.filter(b => b.toLowerCase().includes(val));
        if(matches.length > 0) {
            list.style.display = "block";
            matches.forEach(m => {
                let div = document.createElement('div');
                div.className = "bank-item";
                div.innerText = m;
                div.onclick = () => { document.getElementById('w-bank').value = m; list.style.display = "none"; };
                list.appendChild(div);
            });
        } else { list.style.display = "none"; }
    }
    function formatAmt(input) { let v = input.value.replace(/\D/g, ""); if(v) input.value = Number(v).toLocaleString('vi-VN'); }
    function saveData() { localStorage.setItem('TX_SESS_V4', JSON.stringify({bal: userBalance, user: loggedUser, hist: lichSuCau})); }
    function loadData() {
        const saved = localStorage.getItem('TX_SESS_V4');
        if(saved) {
            const d = JSON.parse(saved); userBalance = d.bal; loggedUser = d.user; lichSuCau = d.hist || [];
            if(loggedUser) { document.getElementById('auth-overlay').style.display="none"; document.getElementById('p-name').innerText = loggedUser; }
        } else { for(let i=0; i<15; i++) { let t = Math.floor(Math.random()*16)+3; lichSuCau.push({side: t>=11?"Tai":"Xiu", total: t}); } }
    }
    function capNhatBalance() { document.getElementById('balance-display').innerText = userBalance.toLocaleString(); document.getElementById('p-bal').innerText = userBalance.toLocaleString() + " VND"; saveData(); }

    window.onload = () => { loadData(); capNhatBalance(); };
</script>
</body>
</html>